<div class="new-cycle-container">
    <h2 mat-dialog-title>Start New Laundry Cycle</h2>
    
    <mat-dialog-content>
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Loading available devices...</p>
        </div>
      } @else if (availableDevices().length === 0) {
        <div class="no-devices">
          <mat-icon>warning</mat-icon>
          <h3>No Available Devices</h3>
          <p>All devices are currently in use. Please wait for a cycle to complete.</p>
        </div>
      } @else {
        <form [formGroup]="cycleForm" (ngSubmit)="onSubmit()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Your Name</mat-label>
            <input matInput formControlName="userId" placeholder="Enter your name">
            <mat-icon matSuffix>person</mat-icon>
            @if (cycleForm.get('userId')?.invalid && cycleForm.get('userId')?.touched) {
              <mat-error>Name is required</mat-error>
            }
          </mat-form-field>
  
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Device</mat-label>
            <mat-select formControlName="deviceId">
              @for (device of availableDevices(); track device.id) {
                <mat-option [value]="device.id">
                  <div class="device-option">
                    <div class="device-info">
                      <mat-icon [class]="getDeviceIconClass(device.type)">
                        {{ getDeviceIcon(device.type) }}
                      </mat-icon>
                      <div>
                        <div class="device-name">{{ device.name }}</div>
                        <div class="device-type">{{ device.type | titlecase }}</div>
                      </div>
                    </div>
                    <div class="device-price">
                      @if (getTariffForDevice(device.id); as tariff) {
                        <span class="price">€{{ tariff.price }}</span>
                      }
                    </div>
                  </div>
                </mat-option>
              }
            </mat-select>
            @if (cycleForm.get('deviceId')?.invalid && cycleForm.get('deviceId')?.touched) {
              <mat-error>Please select a device</mat-error>
            }
          </mat-form-field>
  
          @if (selectedDevice; as device) {
            <mat-card class="selected-device-info">
              <mat-card-content>
                <h4>Selected Device Details</h4>
                <div class="device-details">
                  <div class="detail-item">
                    <mat-icon>{{ getDeviceIcon(device.type) }}</mat-icon>
                    <span>{{ device.name }} ({{ device.type | titlecase }})</span>
                  </div>
                  @if (getTariffForDevice(device.id); as tariff) {
                    <div class="detail-item">
                      <mat-icon>euro</mat-icon>
                      <span>{{ tariff.name }} - €{{ tariff.price }}</span>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          }
        </form>
      }
    </mat-dialog-content>
  
    <mat-dialog-actions align="end">
      <button mat-button (click)="onCancel()">Cancel</button>
      @if (availableDevices().length > 0) {
        <button 
          mat-raised-button 
          color="primary" 
          (click)="onSubmit()"
          [disabled]="cycleForm.invalid || creating()">
          @if (creating()) {
            <mat-spinner [diameter]="20"></mat-spinner>
            <span>Starting...</span>
          } @else {
            <span>Start Cycle</span>
          }
        </button>
      }
    </mat-dialog-actions>
  </div>